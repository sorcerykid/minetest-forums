<!--
  Mintest Forum Recovery Project (by sorcerykid)

  https://sorcerykid.github.io/minetest-forums/pages/47_22461.htm

  The following page was cached by Yandex Bot (https://yandex.com/) on 10-Apr-2019.
  All archived content is subject to copyright. No warranty or guaranty is implied.
-->
<base href="https://forum.minetest.net/" />
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>Minetest Forums &bull; View topic - lua string math and loadstring</title>

<link rel="alternate" type="application/atom+xml" title="Feed - Minetest Forums" href="https://forum.minetest.net/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="https://forum.minetest.net/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - Mods" href="https://forum.minetest.net/feed.php?f=46" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - lua string math and loadstring" href="https://forum.minetest.net/feed.php?f=47&amp;t=22461" />

<!--
	phpBB style name: prosilver
	Based on style:   prosilver (this is the default phpBB3 style)
	Original author:  Tom Beddard ( http://www.subBlue.com/ )
	Modified by:
-->

<link href="./styles/prosilver/theme/print.css" rel="stylesheet" type="text/css" media="print" title="printonly" />
<link href="./style.php?id=5&amp;lang=en" rel="stylesheet" type="text/css" media="screen, projection" />

<link href="./styles/prosilver/theme/normal.css" rel="stylesheet" type="text/css" title="A" />
<link href="./styles/prosilver/theme/medium.css" rel="alternate stylesheet" type="text/css" title="A+" />
<link href="./styles/prosilver/theme/large.css" rel="alternate stylesheet" type="text/css" title="A++" />

</head>

<body id="phpbb" class="section-viewtopic ltr">

<div id="wrap">
	<a id="top" name="top" accesskey="t"></a>
	<div id="page-header">
		<div class="headerbar">
			<div class="inner"><span class="corners-top"><span></span></span>

			<div id="site-description">
				<a href="./index.php" title="Board index" id="logo"><img src="./styles/prosilver/imageset/site_logo.gif" width="149" height="52" alt="" title="" /></a>
				<h1>Minetest Forums</h1>
				<p>The official Minetest discussion board</p>
				<p class="skiplink"><a href="#start_here">Skip to content</a></p>
			</div>

			<span class="corners-bottom"><span></span></span></div>
		</div>

		<div class="navbar">
			<div class="inner"><span class="corners-top"><span></span></span>

			<ul class="linklist navlinks">
				<li class="icon-home"><a href="./index.php" accesskey="h">Board index</a> <strong>&#8249;</strong> <a href="./viewforum.php?f=47">Modding Discussion</a></li>
			</ul>

			<span class="corners-bottom"><span></span></span></div>
		</div>
	</div>

	<a name="start_here"></a>
	<div id="page-body">
		
<h2><a href="./viewtopic.php?f=46&amp;t=22461">lua string math and loadstring</a></h2>
<!-- NOTE: remove the style="display: none" when you want to have the forum description on the topic body -->

<div class="topic-actions">
		<div class="pagination">
			8 posts
			 &bull; Page <strong>1</strong> of <strong>1</strong>
		</div>
</div>
<div class="clear"></div>

	<div id="p347669" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			<h3 class="first"><a href="https://sorcerykid.github.io/minetest-forums/pages/47_22461.htm#p347669">lua string math and loadstring</a></h3>
			<p class="author"><img src="./styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>Kilarin</strong> &raquo; Sun Mar 31, 2019 5:47 pm </p>

			<div class="content">in a project I'm working on, I end up with a string that is a mathematical equation. like:<br />local equation=&quot;8+5&quot;<br />there should be NOTHING but numbers and mathematical operators in the string, and I can, of course, verify that in the code.<br />but I need to convert that equation into an actual number.<br />I had a fancy schmancy Java routine that would handle all kinds of string math.   I'm trying to determine how to do this in lua.<br />It looks like I could accomplish this using loadstring?<br /><br />BUT, loadstring looks like a very risky thing to implement.  With sufficient code checks to ensure there will be no arbitrary lua code execution, is loadstring considered acceptable in minetest mods?<br /><br />Is there some other built in way to convert string equations into actual numerical results?</div>
		</div>

			<dl class="postprofile">
			<dt>
				<strong>Kilarin</strong>
			</dt>
			<dd>Member</dd>

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 717</dd><dd><strong>Joined:</strong> Mon Mar 10, 2014 12:36 am</dd>
			
			
		</dl>
	
		<div class="back2top"><a href="#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />
	<div id="p347710" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			<h3 class=""><a href="https://sorcerykid.github.io/minetest-forums/pages/47_22461.htm#p347710">Re: lua string math and loadstring</a></h3>
			<p class="author"><img src="./styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>Kilarin</strong> &raquo; Mon Apr 01, 2019 4:25 am </p>

			<div class="content">Never mind.  I think I worked out a nice routine with a good whitest that should handle the problem.  Will post if anyone wishes to critique it.</div>
		</div>

			<dl class="postprofile">
			<dt>
				<strong>Kilarin</strong>
			</dt>
			<dd>Member</dd>

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 717</dd><dd><strong>Joined:</strong> Mon Mar 10, 2014 12:36 am</dd>
			
			
		</dl>
	
		<div class="back2top"><a href="#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />
	<div id="p347747" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			<h3 class=""><a href="https://sorcerykid.github.io/minetest-forums/pages/47_22461.htm#p347747">Re: lua string math and loadstring</a></h3>
			<p class="author"><img src="./styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>ShadMOrdre</strong> &raquo; Mon Apr 01, 2019 3:53 pm </p>

			<div class="content">Please do let us view the code.</div>
		</div>

			<dl class="postprofile">
			<dt>
				<strong>ShadMOrdre</strong>
			</dt>
			<dd>Member</dd>

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 272</dd><dd><strong>Joined:</strong> Mon Dec 29, 2014 8:07 am</dd>
			<dd><strong>GitHub:</strong> ShadMOrdre</dd>
			<dd><strong>In-game:</strong> shadmordre</dd>
		</dl>
	
		<div class="back2top"><a href="#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />
	<div id="p347795" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			<h3 class=""><a href="https://sorcerykid.github.io/minetest-forums/pages/47_22461.htm#p347795">Re: lua string math and loadstring</a></h3>
			<p class="author"><img src="./styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>Kilarin</strong> &raquo; Mon Apr 01, 2019 11:29 pm </p>

			<div class="content"><dl class="codebox"><dt>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code>--does string math<br />--acceptable values:<br />--numbers .+-*/^ ()<br />--math library functions<br />--this function does this validation so that you can be certain it cant execute arbitrary lua code.<br />--vars array is optional, if you pass in an array of variables and values they will be substituted before calculation<br />--********************************<br />function string_math(str,vars)<br />&nbsp; &nbsp; for k,v in pairs(vars) do<br />&nbsp; &nbsp; &nbsp; str=string.gsub(str,k,v)<br />&nbsp; &nbsp; end --for&nbsp; <br />&nbsp; end --if&nbsp; <br />&nbsp; --now all variables have been substituted, test if string is math ONLY <br />&nbsp; --(do not allow arbitrary lua code execution)&nbsp; <br />&nbsp; --is there a reason to define this array globaly or external to the function?&nbsp; &nbsp; <br />&nbsp; local allowed={&quot;math%.abs&quot;,&quot;math%.acos&quot;,&quot;math%.asin&quot;,&quot;math%.atan&quot;,&quot;math%.ceil&quot;,<br />&nbsp; &nbsp; &quot;math%.cos&quot;,&quot;math%.deg&quot;,&quot;math%.exp&quot;,&quot;math%.floor&quot;,&quot;math%.fmod&quot;,&quot;math%.huge&quot;,<br />&nbsp; &nbsp; &quot;math%.log&quot;,&quot;math%.max&quot;,&quot;math%.maxinteger&quot;,&quot;math%.min&quot;,&quot;math%.mininteger&quot;,<br />&nbsp; &nbsp; &quot;math%.modf&quot;,&quot;math%.pi&quot;,&quot;math%.rad&quot;,&quot;math%.random&quot;,&quot;math%.randomseed&quot;,<br />&nbsp; &nbsp; &quot;math%.sin&quot;,&quot;math%.sqrt&quot;,&quot;math%.tan&quot;,&quot;math%.tointeger&quot;,&quot;math%.type&quot;,&quot;math%.ult&quot;,<br />&nbsp; &nbsp; &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;,&quot;%.&quot;,&quot;+&quot;,&quot;-&quot;,&quot;*&quot;,&quot;/&quot;,&quot;%^&quot;,&quot;%(&quot;,&quot;%)&quot;,&quot;,&quot;,&quot; &quot;}&nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; local test=str&nbsp; <br />&nbsp; for k,v in pairs(allowed) do <br />&nbsp; &nbsp; test=string.gsub(test,v,&quot;0&quot;)&nbsp; --change EVERYTHING that is allowed into 0&nbsp; <br />&nbsp; end --for a<br />&nbsp; --so why change everything to 0 instead of just &quot;&quot;?&nbsp; paranoia, it means<br />&nbsp; --something like mathmath.pi.floor cant slip through, although I am not<br />&nbsp; --certain what someone could do with that anyway<br />&nbsp; --math.pi3 CAN slip through, but again, I'm not certain what someone could<br />&nbsp; --do with that.<br />&nbsp; test=string.gsub(test,&quot;0&quot;,&quot;&quot;)&nbsp; --remove all zeros<br />&nbsp; local rslt=&quot;&quot;<br />&nbsp; if test==&quot;&quot; then --if the string was good, it should now be empty<br />&nbsp; &nbsp; rslt=loadstring(&quot;return &quot;..str..&quot;+0&quot;)()<br />&nbsp; else<br />&nbsp; &nbsp; rslt=&quot;Invalid String&quot;<br />&nbsp; end --if test==&quot;&quot;&nbsp; <br />&nbsp; <br />return rslt<br />end&nbsp; --string_math</code></dd></dl><br /><br /><br />---example call:<br /><dl class="codebox"><dt>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code>local vars={clowns=3,monkeys=5,ringmasters=1}<br /><br />str=&quot;math.floor((clowns+monkeys)/(ringmasters*math.pi))&quot; --this would probably be read in from a settings file<br />circus=string_math(str,vars)<br /></code></dd></dl><br />and now circus=2<br /><br />So, what is the purpose of this?  <br />I'm using it to allow values as formulas to be put into a settings file instead of having to be coded into the init.lua<br />So the user can say in the setting file:<br />tentsize=(monkeys*clowns)/ringmasters<br />and my lua can read that in and calculate the result on the fly.<br /><br />I think a settings file is a bit more accessible for many users.<br />PLUS, it has the advantage that updating the code does not wipe out all of the users settings/preferences.<br />I just needed a way to be able to do MATH on the settings with variables so the user could enter formulas.  But I'm paranoid and wanted to try and limit arbitrary lua code execution</div>
		</div>

			<dl class="postprofile">
			<dt>
				<strong>Kilarin</strong>
			</dt>
			<dd>Member</dd>

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 717</dd><dd><strong>Joined:</strong> Mon Mar 10, 2014 12:36 am</dd>
			
			
		</dl>
	
		<div class="back2top"><a href="#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />
	<div id="p347826" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			<h3 class=""><a href="https://sorcerykid.github.io/minetest-forums/pages/47_22461.htm#p347826">Re: lua string math and loadstring</a></h3>
			<p class="author"><img src="./styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>ShadMOrdre</strong> &raquo; Tue Apr 02, 2019 7:24 am </p>

			<div class="content">Thanks for posting.<br /><br />Try the <a href="https://forum.minetest.net/viewtopic.php?id=7800" class="postlink">str_helpers</a> mod.  Might be useful for breaking apart strings, or show you how to code something else.</div>
		</div>

			<dl class="postprofile">
			<dt>
				<strong>ShadMOrdre</strong>
			</dt>
			<dd>Member</dd>

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 272</dd><dd><strong>Joined:</strong> Mon Dec 29, 2014 8:07 am</dd>
			<dd><strong>GitHub:</strong> ShadMOrdre</dd>
			<dd><strong>In-game:</strong> shadmordre</dd>
		</dl>
	
		<div class="back2top"><a href="#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />
	<div id="p347840" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			<h3 class=""><a href="https://sorcerykid.github.io/minetest-forums/pages/47_22461.htm#p347840">Re: lua string math and loadstring</a></h3>
			<p class="author"><img src="./styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>rubenwardy</strong> &raquo; Tue Apr 02, 2019 10:39 am </p>

			<div class="content">Manually parsing strings like that is insecure and really not a good idea.<br /><br />Use a sandbox instead, see how mesecon's lua controller does it: <!-- m --><a class="postlink" href="https://github.com/minetest-mods/mesecons/blob/master/mesecons_luacontroller/init.lua#L436-L553">https://github.com/<a class="postlink" href="https://github.com/minetest-mods/mesecons/blob/master/mesecons_luacontroller/init.lua#L436-L553">minetest-mods/meseco ... #L436-L553</a><!-- m --></div>
		</div>

			<dl class="postprofile">
			<dt>
				<strong>rubenwardy</strong>
			</dt>
			<dd>Moderator</dd>

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 5717</dd><dd><strong>Joined:</strong> Tue Jun 12, 2012 6:11 pm</dd>
			<dd><strong>GitHub:</strong> rubenwardy</dd>
			<dd><strong>In-game:</strong> rubenwardy</dd>
		</dl>
	
		<div class="back2top"><a href="#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />
	<div id="p347858" class="post bg2">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			<h3 class=""><a href="https://sorcerykid.github.io/minetest-forums/pages/47_22461.htm#p347858">Re: lua string math and loadstring</a></h3>
			<p class="author"><img src="./styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>Kilarin</strong> &raquo; Tue Apr 02, 2019 1:36 pm </p>

			<div class="content">THAT is exactly what I came here for.   White listing is certainly better than Black listing, but it still left my nerves on edge.  This will be a better solution.<br /><br />THANK YOU!</div>
		</div>

			<dl class="postprofile">
			<dt>
				<strong>Kilarin</strong>
			</dt>
			<dd>Member</dd>

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 717</dd><dd><strong>Joined:</strong> Mon Mar 10, 2014 12:36 am</dd>
			
			
		</dl>
	
		<div class="back2top"><a href="#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />
	<div id="p348335" class="post bg1">
		<div class="inner"><span class="corners-top"><span></span></span>

		<div class="postbody">
			<h3 class=""><a href="https://sorcerykid.github.io/minetest-forums/pages/47_22461.htm#p348335">Re: lua string math and loadstring</a></h3>
			<p class="author"><img src="./styles/prosilver/imageset/icon_post_target.gif" width="11" height="9" alt="Post" title="Post" />by <strong>Kilarin</strong> &raquo; Mon Apr 08, 2019 2:22 am </p>

			<div class="content">Is this properly implemented sandboxing?<br /><br /><dl class="codebox"><dt>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code>--********************************<br />function luautils.string_math(str,vars)<br />&nbsp; if vars~=nil then --substitute variables<br />&nbsp; &nbsp; for k,v in pairs(vars) do<br />&nbsp; &nbsp; &nbsp; str=string.gsub(str,k,v)<br />&nbsp; &nbsp; end --for&nbsp; <br />&nbsp; end --if&nbsp; <br />&nbsp; --sandbox for security (do not allow arbitrary lua code execution)&nbsp; <br />&nbsp; local env = {loadstring=loadstring, math = {<br />&nbsp; &nbsp; abs = math.abs,<br />&nbsp; &nbsp; acos = math.acos,<br />&nbsp; &nbsp; asin = math.asin,<br />&nbsp; &nbsp; atan = math.atan,<br />&nbsp; &nbsp; atan2 = math.atan2,<br />&nbsp; &nbsp; ceil = math.ceil,<br />&nbsp; &nbsp; cos = math.cos,<br />&nbsp; &nbsp; cosh = math.cosh,<br />&nbsp; &nbsp; deg = math.deg,<br />&nbsp; &nbsp; exp = math.exp,<br />&nbsp; &nbsp; floor = math.floor,<br />&nbsp; &nbsp; fmod = math.fmod,<br />&nbsp; &nbsp; frexp = math.frexp,<br />&nbsp; &nbsp; huge = math.huge,<br />&nbsp; &nbsp; ldexp = math.ldexp,<br />&nbsp; &nbsp; log = math.log,<br />&nbsp; &nbsp; log10 = math.log10,<br />&nbsp; &nbsp; max = math.max,<br />&nbsp; &nbsp; min = math.min,<br />&nbsp; &nbsp; modf = math.modf,<br />&nbsp; &nbsp; pi = math.pi,<br />&nbsp; &nbsp; pow = math.pow,<br />&nbsp; &nbsp; rad = math.rad,<br />&nbsp; &nbsp; random = math.random,<br />&nbsp; &nbsp; sin = math.sin,<br />&nbsp; &nbsp; sinh = math.sinh,<br />&nbsp; &nbsp; sqrt = math.sqrt,<br />&nbsp; &nbsp; tan = math.tan,<br />&nbsp; &nbsp; tanh = math.tanh,<br />&nbsp; &nbsp; }}&nbsp; &nbsp; <br />&nbsp; &nbsp;<br />&nbsp; local f=function() return loadstring</nobr>(&quot;return &quot;..str..&quot;+0&quot;)() end<br /><br />&nbsp; setfenv(f,env)<br />&nbsp; local rslt=f()<br />&nbsp; <br />&nbsp; return rslt<br />end&nbsp; --string_math<br /></code></dd></dl></div>
		</div>

			<dl class="postprofile">
			<dt>
				<strong>Kilarin</strong>
			</dt>
			<dd>Member</dd>

		<dd>&nbsp;</dd>

		<dd><strong>Posts:</strong> 717</dd><dd><strong>Joined:</strong> Mon Mar 10, 2014 12:36 am</dd>
			
			
		</dl>
	
		<div class="back2top"><a href="#wrap" class="top" title="Top">Top</a></div>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<hr class="divider" />

	<hr class="divider" />

	<hr />

<div class="topic-actions">
		<div class="pagination">
			8 posts
			 &bull; Page <strong>1</strong> of <strong>1</strong>
		</div>
</div>

	<p></p><p><a href="./viewforum.php?f=47" class="left-box left" accesskey="r">Return to Modding Discussion</a></p>

	<br /><br />

	<h3>Who is online</h3>
	<p>Users browsing this forum: <span style="color: #9E8DA7;" class="username-coloured">Yandex Bot [Bot]</span> and 0 guests</p>
</div>

<div id="page-footer">

	<div class="navbar">
		<div class="inner"><span class="corners-top"><span></span></span>

		<ul class="linklist">
			<li class="icon-home"><a href="./index.php">Board index</a></li>
				
			<li class="rightside">All times are UTC </li>
		</ul>

		<span class="corners-bottom"><span></span></span></div>
	</div>

	<div class="copyright">Powered by <a href="https://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
		
	</div>
</div>

</div>

<div>
	<a id="bottom" name="bottom" accesskey="z"></a>
	
</div>

</body>
</html></div>

